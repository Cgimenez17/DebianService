 /* Comando para saber la version de Ubuntu
cat /etc/os-relaese
lsb_release -idc */
#######BASE DE DATOS
psql -U postgres -h localhost digito_rse < /ruta/de/bd

pass que usamos generalmente sql$

CONEXION DE BASE DE DATOS EN EL STANDALONE.XML

<datasource jta="true" jndi-name="java:/jboss/datasources/PayrollREST" pool-name="POLL_PayrollREST" enabled="true" use-ccm="f>
                    <connection-url>jdbc:postgresql://localhost:5432/payroll</connection-url>
                    <driver-class>org.postgresql.Driver</driver-class>
                    <driver>postgresql-driver</driver>
                    <security>
                        <user-name>postgres</user-name>
                        <password>sql$</password>
                    </security>

CONFIGURACION MAIL SESSION EN EL STANDALONE.XML
<mail-session name="PayrollMailSession" debug="true" jndi-name="java:jboss/mail/PayrollMailSession" from="recibosrrhh@yacyreta.com.py">
<custom-server name="smtp" outbound-socket-binding-ref="mail-smtp" ssl="false" tls="true">
<property name="mail.smtp.auth.mechanisms" value="XOAUTH2"/>
</custom-server>
</mail-session>
recuerda pedir al cliente los siguientes datos:

mail.tenant.com= 

client_secret=

client_id= 

username=

password=

ID tenant=


el ID tenant se coloca en Oauth-config.properties

el resto en payroll-config.properties 
##########################################
dump ---> volcado de base de datos.


#######PASOS#######
1. INSTALAR JDK 8 ! 
2. INSTALAR POSTGRES 14 ! 
3. desplegar la base de DRSE en el postgres, la base de datos debe llamarse digito_rse !
4. COPIAR LA CARPETA WILDFLY A LA CARPETA /opt/ !
5. hacer la conexion del wildfly con la base de datos y puertos para ingresar a la aplicacion !
en el archivo standalone.xml ! 
6. levantar el servicio desde la carpeta bin del wildfly sudo ./standalone.sh !
7. copiar la carpeta app-roll a opt !
8. crear una carpeta con el nombre dir_payroll

###################################################3
sudo -u postgres psql --> entrar al usuario postgres
ALTER USER nombre_usuario WITH PASSWORD 'nueva_contraseña';   --> crea un nuevo usuario de postgres
ir a la carpeta cd /var/lib/pgsql/14/data/   ----> edit pg_hba.conf --->>> cambiar a md5
#############################################################

https://192.168.40.96:8686/payroll   --> Ambiente de prueba DIGITO RSE

#############################COMANDOS PARA RECARGAR LOS CAMBIOS REALIZADOS############################################
  103  sudo systemctl daemon-reload
  107  sudo systemctl restart postgresql 
###########################################################################

docker ps --> listar los contenedores activos
docker ps -a --> listar los contenedores activos y los no activos
docker start "id_del_contenedor" --> hacer correr el contenedor
docker stop --> "id_del_contenedor" --> detener el contenedor
docker restart "id_del_contenedor" --> reiniciar el contenedor
docker logs -f --tail 100 "id_del_contenedor" --> ver las ultimas 100 lineas del LOG del contenedor
docker exec -i "id_del_contenedor" /bin/bash --> entrar a la terminal del contenedor
sudo docker exec -it "id_del_contenedor" pg_dump -U postgres -h localhost digito_fe_banano_old > /home/roberto.fretes@documenta.com.py/prueba_backup12012024-1.sql 
docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}" --> ver los contenedores de manera mas simplificada, se pueden elegir los parametros a visualizar siguiendo la sintaxis
tail -f 100 "directorio del log del wildfly" --> ver el log del wildfly si no esta instalado por docker
###########################################################################
Soporte 1 --> IDESA --> cambio de los permisos de los Usuarios para poder visualizar la version 1 del DRSE
Soporte 2 RAIZEN --> Problema con el csv, el campo "Cargo" estaba con C mayuscula y deberia de ser "cargo" de igual forma el campo "Dirección" deberia de ser "direccion", esto indica que las columnas del csv
siempre deben de estar separadas con ";" y no debe incluir mayusculas ni caracteres especiales. EJ tilde
Soporte 3 RAIZEN --> Ajuste de Plantilla, cambio en el HTML
##############################################################################
INSTALACION sin SERVISIGN PATRIA SEGUROS --> https://192.168.65.19:9101/payroll/#/dashboard
INSTALACION SUMMIT AGRO sin nateo https://192.168.30.92:9101/payroll/#/dashboard
INSTALACION EN LA NUBE
Copiar los archivos del front y back actualizados

######################################################################################
conectarse por ssh "usuario"@"IP"
docker ps -a
docker images --> ver las imagenes de los docker
docker rmi "id_del_contenedor" --> eliminar una imagen de docker
docker rm "id_del_contenedor" --> eliminar el contenedor de docker
PERMITE VER LA IP ASIGNADA POR DOCKER A LOS CONTENEDORES

docker ps -q | xargs docker inspect -f '{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}} {{end}}'

PERMITE VER LA IP ASIGNADA POR DOCKER A LOS CONTENEDORES Y LOS QUE NO ESTAN EN EJECUCION

docker ps -a | awk '{if(NR>1) print $1}' | xargs docker inspect -f '{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}} {{end}}'

sudo docker exec -it 8f2 pg_dump -U postgres -h localhost digito_fe_banano_old > /home/roberto.fretes@documenta.com.py/prueba_backup12012024-1.sql
docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"
#############################
ssh root@192.168.40.96 --> conexion al 4096
a.123456
docker logs -f --tail 100 05f --> ver el log del 4096
###########################Instalacion FE desde 0, on premise###########################
instalar docker cualquier version
instalar docker compose 3.9
entrar al home y si no hay carpetas crear, /home/digito-documenta/digito-fe 
copiar los archivos digito-fe y postgres14-fe al /home/digito-documenta/digito-fe
crear una carpeta en /opt que se llame /digito/ y dentro de la carpeta digito la carpeta /digito-fe/ 
copiar el contenido de /home/digito-documenta/digito-fe al directorio /opt/digito/digito-fe
entrar en /opt/digito/digito-fe/bin y ejecutar el archivo ./install.sh
crear una carpeta en /opt/digito/ que se llame /postgres14
copiar el contenido de /home/digito-documenta/postgres14-fe en /opt/digito/postgres14
entrar en /opt/digito/postgres14/bin y ejecutar el archivo ./BD_fe_installer.sh
despues de instalar los contenedores, reiniciarlos
##########################Instalacion FE, SaaS####################################

##################################################################################
Buscar errores en el 4096 y ver que tira en el log

User: soporte passwd : 123
Error al realizar la firma de una liquidacion
13:10:58,810 INFO  [stdout] (pool-31-thread-3) 
13:10:58,811 INFO  [stdout] (pool-31-thread-3) 
13:10:58,811 INFO  [stdout] (pool-31-thread-3) 
13:10:58,811 INFO  [stdout] (pool-31-thread-3) Duración de la petición: 40 segundos
13:10:58,811 INFO  [py.com.documenta.rafirmadorweb.FirmadorWeb] (pool-31-thread-3) 
[{"typeResult":"ERROR","message":"No se puedo firmar el documento: No se puede firmar el documento: No se pudo realizar la firma del archivo ","value":false}]
##########################INSTALACION RSE SIN SERVISIGN TAPITI#####################3
Ya hay empresas, usuarios y liquidaciones cargadas, asi como tambien plantillas.
Se debe actualizar la base de datos a la ultima version, actualizar el front y los .war a la version sin servisign
##·--->>>##PENDIENTE###<----##
Direccion de correo 
#####################Tipo de encriptacion utilizada para las contraseñas####################################
Para la base de datos --> md5
#####################Instalacion Zavidoro Corporation#########################################
IP Publica del firmador electronico --> http://138.186.63.146:9882/stampwaycorp/api/
IP DE ZAVIDORO CORPORATION, SOLO ACCESO INTERNO --> https://198.164.198.40:9101/payroll/
###########################Pendientes 03 abril 2024######################################
Carsa, falta probar la firma con el cliente de la mano de el departamento de operaciones
fapasa, sin retorno del cliente, envie correos y llame al contacto de la empresa y no tengo aun retorno de las credenciales de la VPN
SUMMIT AGRO SPA --> instalacion SaaS realizada, Se le solicitó al cliente los datos de la empresa, SUMMIT AGRO para continuar con la instalación, conceptos para el CSV y la plantilla de comprobantes.
          Falta solicitar al cliente credencial del correo para la notificación, y definir si dicho correo vamos a proveer nosotros o el cliente.
################################################################################################################
#######################Documentacion de terminos comunes utilizados en DIGITO#####################################
https://docs.google.com/spreadsheets/d/1z0ufR-6FWCqWBHe7sIKNPTKjgueNkqVtFEgksV_x4mk/edit?pli=1#gid=0
#######################################SOPORTE PARA LASCA##########################################################################
Lasca solicito borrar unos comprobantes de prueba que hicieron
Los pasos a seguir son, identificar el lote que debe ser eliminado, con el codigo de la liquidacion, y sacando el id lote
Luego con el id lote sacamos el idliquidacion para proceder con la eliminacion
eliminamos primeramente en la tabla comprobante total, luego en comprobanteinformacionadicional, comprobantefirma, comprobanteestado, comprobantedetalle, comprobante, liquidacion, y por ultimo de la tabla lote
recordar siempre commitear cuando la base de datos esta en produccion, y tener cuidado con los cambios realizados si el sistema se encuentra en este entorno
id lote 103 = idliquidacion 571
id lote 105 = idliquidacion 579


lasca tuvo un problema con las firmas, en algunos documentos de algunos empleados aparecia firma parcial de representantes, sin embargo ya no permitia firmar, 
se debe a un problema de intermitencia con el signbox y se puede solucionar actualizando algunos datos de las tablas liquidacionestado(deja el ultimo estado como activo),
 tambien la tabla liquidacion, se cambia el estado a firma parcial, ya que estaba en firma total de comprobantes
y la tabla comprobantefirma con el idempleado de la persona que no está logrando firmar, se desmarca las casillas de firmado
##############################################################SELECTS########################################################################
select * from public.comprobante c where c.idcomprobante in(8379,7727,7607,10539); -- dañado



select * from comprobante c where c.estado = 'Firma parcial de representantes' and idliquidacion = 587


select * from liquidacion l whe, re idliquidacion = 587

select  * from liquidacionestado l where idliquidacion = 587

select * from comprobante c where idcomprobante in (select idcomprobante 
from comprobante c where c.estado = 'Firma parcial de representantes' and idliquidacion = 587)


select * from comprobantefirma c where idcomprobante in (select idcomprobante 
from comprobante c where c.estado = 'Firma parcial de representantes' and idliquidacion = 587)

select * from firmante f where idplantilla = 1


select * from liqprocesofirma l where idliquidacion = 587


select * from tipoestacomprobante t 



SELECT public.fn_verify_sign(:pidliquidacion, :pidempleado);

#############################################################################################################################################
################Script de sql para buscar el idempleado con nombre y apellido concatenado############################
select u.idusuario,concat(e.nombre,' ', e.apellido) from base.usuario u inner join base.empleado e 
on u.idempleado = e.idempleado where e.nombre ilike '%celeste%' and e.apellido ilike '%alvarez%'
####################################################################################################################
Pendientes 05/04/2024
FAPASA ---> sin retorno, posiblemente hay que insistir de nuevo al cliente
LASCA ---> Estamos esperando que el cliente realice la prueba de la firma, y vuelva a enviar un correo reclamando errores en los pdf's
RAIZEN --> reunion tecnica a las 10:00hs ?? = este cliente solicito un acompañamiento en el inicio del proceso de contingencia, es una configuracion que se realiza en la INFRAESTRUCTURA del sistema,
pero estamos presentes para responder algunas preguntas que tengan sobre el servidor, y sobre la base de datos. Las preguntas que hicieron es que si al cambiar el IP del servidor, es necesario cambiar tambien
en el docker, pero esto no es necesario ya que el docker reconoce automaticamente la IP del servidor y realiza la conexión, y la otra pregunta es que si al hacer el backup de la base de datos y restaurar este backup 
en el entorno de contingencia el sistema va a funcionar sin problemas nuevamente, y en teoria esto deberia de funcionar pero se realizara otra reunion para verificar esto.
OBS: Al restaurar en el entorno de contingencia el backup de la base de datos, funciona / no funciona ??


ID PARAMETRO PARA TOCAR EN LA BD DE RSE UNA VEZ RECIEN INSTALADO EL SISTEMA
5
####
ACTIVE DIRECTORY
7
8
9
10
11
12
####
32 es el que activa las notificaciones de los comprobantes en el sistema de RSE, debe estar true cuando el cliente sale a producción
61	dfw.api.urlbase	Url base del servidor de firmas http://138.186.63.146:9882/stampwaycorp/api/


##########################################Solicitud de separacion de base de datos para cada empresa, NEGOFIN#####################################
Primeramente se necesita hacer un backup de la base de datos para evitar desgracias
Se necesita crear 3 contenedores de docker para cada wildfly, con 3 bases de datos distintas, pero esas 3 bases de datos se conectan solamente con un contenedor de postgres
A cada contenedor de wildfly se necesita hacer la configuracion de conexion de base de datos que le pertenece a dicho contenedor, en la carpeta standalone.xml
Paso 1, instalar las 3 bases de datos limpias con los nombres de las empresas, "empresa1" "empresa2" "empresa3"
Paso 2, configurar los archivos de instalacion del docker, especificamente el archivo env_produccion que se encuentra en /home/cesar/Escritorio/RSE_C/Contenedor_RSE/Contenedor/digito-rse-v2_sucursal_sin_servisign/digito-rse/image/config
Paso 3, instalar los contenedores, con un puerto distinto, nombre de base de datos distinta y puertos distintos, para poder realizar la conexion y configuracion luego.
apuntar los contenedores a volumenes diferentes

----------------------------------------------------Prueba de forma local--------------------------------------------------------------------------------------------
Para borrar los datos de la empresa hay que hacerlo paso por paso ya que no nos permitira eliminar un dato que esta puesto en otra tabla diferente de la base de datos, 
Primera tabla a tocar es la tabla Usuario rol, y eliminar todos los usuarios que tengan que ver con el idempresa.
Segunda tabla a tocar es la tabla Usuario, y eliminar todos los usuarios que tengan que ver con la empresa.
tercera tabla a tocar es la tabla sucursal, y eliminar todas las sucursales que tengan que ver con el idempresa que queremos eliminar
OBS: DE FORMA LOCAL NO EXISTIAN LIQUIDACIONES CARGADAS POR ESO FUE FACIL BORRAR, TENER EN CUENTA QUE LA EMPRESA NEGGOFIN Y LAS DEMAS EMPRESAS SI TENDRAN LIQUIDACIONES
Y HAY QUE BORRAR TODO LO QUE TENGA QUE VER CON CUALQUIER EMPRESA QUE QUERAMOS ELIMINAR DE LA BASE DE DATOS.
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

Errores encontrados y su solucion
Id. Comprobante: 27541, respuestaSolicitudFima=No se pudo codificar el archivo a base64., tiempoRespuestaSolicitudFima=null ms., respuestaEstadoComprobante=null, tiempoRespuestaEstadoComprobante=null ms., tiempoTotalEjecución= null ms., isDocumentoFirmado=false, isXmlFirmado=false --> El problema fue que estaba buscando un pdf que no existia, esto sucedio porque a la hora de migrar los datos de la BD habia que migrar la carpeta de los comprobantes de igual forma, entonces al realizar una firma con un archivo que ya esta registrado en la base de datos va a buscar un archivo que no existe.



##################################################################################################################################
--------------------------------------------Facturacion Electronica--------------------------------------------------------
DE --> Documento Electronico, cualquier tipo de documento que sea transmitible a la SIFEN
        FE--> Factura electronica
        NCE--> Nota de credito electronica
        NDE--> Nota de Débito electronica
        NRE --> Nota de Remision electronica
        AFE--> Autofactura electronica
---------------------------------------------------------------------------------------------------------------------------
Integracion por API
Integracion por archivo
Utilizacion por INTERFAZ
---------------------------------------------------------------------------------------------------------------------------
KuDE --> factura grafica
xml --> factura que se le envia a la SIFEN para el procesamiento
Ekuatia --> pagina de consulta de la SIFEN
---------------------------------------------------------------------------------------------------------------------------
Datos necesarios luego de realizar la instalacion a un cliente
1- certificado tributario F1
2- Timbrado de test y produccion
3- Logo de facturas y modelo de facturas que utilizan
4- Probar la conexion con la SIFEN 
----------------------------------------------------------------------------------------------------------------------------
------------------------------------------Etapas de los estados de los DE
En proceso de aprobacion --> Aprobado por SIFEN / RECHAZADO POR SIFEN
/
---------------------------------------------------------------------------------------------------------------------------
------------------------------------------API REST SIRIUS------------------------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------
SOPORTE CARSA
Error de firma, el comprobante en la base de datos aparece como firma parcial pero al visualizar el pdf en el lote aparecen las dos firmas,
este error se debe a a la intermitencia que tiene el servidor de firmas y no actualizo el estado en la BD.
Se soluciona modificando el estado y dandole check a firmadoempresa en la tabla public.comprobante
Y en la tabla comprobanteestado se duplico la ultima linea y se cambio el idtipoestacomprobante a "2" que en la BD es Firma total de representantes, se puso como activo





---------------------------------------------------------------------SCRIPT BASE DE DATOS-----------------------------------------------------------------------------
Para ver las conexiones activas y quién está conectado, puedes utilizar la vista pg_stat_activity en PostgreSQL. Ejecuta la siguiente consulta SQL en psql o cualquier cliente de PostgreSQL:

    SELECT * FROM pg_stat_activity;
Esto mostrará información sobre todas las conexiones activas al servidor de bases de datos, incluyendo detalles como el usuario, el estado de la conexión, la consulta que se está ejecutando, entre otros.

Desconectar sesiones específicas:
Para desconectar una sesión específica, identifica el pid de la conexión que deseas cerrar a partir de la consulta pg_stat_activity, luego utiliza el siguiente comando SQL:

  SELECT pg_terminate_backend(1517);



-------------------------------------------------------------------ACTUALIZACION DEL CONTENEDOR DFE----------------------------------------------------------------------
Se actualizaron los .war, el front "sirius" y se realizo un dump de la base de datos mas actualizada con todos los scripts añadidos(11-04-2024)



------------------------------------------------------------------Configuración de OAUTH en Office Exchange------------------------------------------------------------------
Primeramente se debe de realizar el registro de la aplicación de RS en el Azure Active Directory, luego del registro se estarán generando el id de la aplicacion (client_id) que deberían de ser facilitados
al igual que el tenant ID (correspondería el id del servidor). Finalmente se debe de generar un secret key mediante el menu de ("Certificados y secretos o Certificates and Secrets") --> estos datos son utilizados para la obtención del token de autenticacion .

Luego dirigirse al aparte de Api Permissions y agregar el permiso de "SMTP.Send".

Luego se debería de ejecutar los siguientes comandos en PowerShell.

$ Install-Module -Name ExchangeOnlineManagement -allowprerelease
$ Install-Module Microsoft.Graph -allowprerelease
$ Install-Module -Name AzureAD

$ import-module AzureADPreview
$ import-module ExchangeOnlineManagement

$ Connect-AzureAD -Tenant tanantID // reemplazar tanantID por el correspondiente /* este comando abrira una ventana para colocar las credenciales(user y pass) del correo electronico */

$ Connect-ExchangeOnline -Organization tanantID // reemplazar tanantID por el correspondiente

$ $MyApp = Get-AzureADServicePrincipal -SearchString NombreDelaAplicacionRegistradaEnADD /* se agrega una variable para recuperar datos */

$ New-ServicePrincipal -AppId $MyApp.AppId -ServiceId $MyApp.ObjectId -DisplayName "Settings for Oauth"

$ Add-MailboxPermission -Identity "recibosrrhh@yacyreta.com.py" -User $MyApp.ObjectId -AcessRigths FullAccess

Tambien en PowerShell modificar el valor de SmtpClientAuthenticationDisable a False

$ Set-CASMailbox -Identity <username of mail> -SmtpClientAuthenticationDisabled $false

$ Get-TransportConfig | Format-List SmtpClientAuthenticationDisabled // verificar que contenga el valor false


----------------------------------------------------------------Error de la tabla item al realizar una actualizacion DFE------------------------------------------------------------------
Crear la tabla item con el script ya existente en el entorno de pruebas

Actualizacion fecha 15/04/2024
Y luego insertar las columnas que debe llevar dicha tabla
INSERT INTO base.item (idempresa, iditem, idtipounidadmedida, idpaisorigen, codigointerno, descripcionproducto, infoitem, idtipoafectaciontributaria, idtipotasaiva, preciounitario, active, aud_fecalta, aud_fecmodif, aud_idusuarioalta, aud_idusuariomodif) VALUES(0, nextval('base.item_iditem_seq'::regclass), 0, 0, '', '', '', 0, 0, 0, false, '', '', 0, 0);


------------------------------------------------Retransmision de los DE--------------------------------------------------------------------------------------------------------------------
Si duplicas un registro en el lote desactivar el lote duplicado, luego se va a genenerar un nuevo idlote y ese idlote pegar en las facturas que están duplicadas y ahí activar dichas facturas, las facturas que no se procesaron se dejan asi y listo

QUERYS QUE PUEDEN SERVIR PARA LA RETRANSMISION DE DOCUMENTOS: 
select * from sifen.documentoelectronico d where idde = 310692;
select * from sifen.lotedetalleevento l where  idde in (310692,310747);
select d.* from sifen.documentoelectronico d 
join sifen.timbrado t on t.idempresa = d.idempresa and t.idde = d.idde 
where t.nrodeldocumento in (12654, 12680);
select * from sifen.lote l where idlote = 37403;


OR


select * from sifen.documentoelectronico d join sifen.timbrado t on t.idempresa = d.idempresa and t.idde = d.idde
where d.idtipoestadodeultimo = 7 and t.nrodeldocumento in (35294, 35293, 35292, 35291, 14921, 35295);

select * from sifen.lotedetalleevento l where idde in (910955,
910956,
910957,
910958,
910961,
911397) order by idde ,fechoraevento ;

select * from sifen.lote l2 where idlote = 137399; 
------------------------------------------------------------------------------------------------------------------------------------------
PPENDIENTES
                          RSE                           

SUMMIT AGRO --> Aguardando retorno de las credenciales de correo
Tapiti --> aguardando validacion de las credenciales de correo 
Zavidoro --> Adaptar CSV y plantilla, configurar correos
negofin --> Separacion de base de datos 

###########################################################################################################################################################################################################
--------------------------------------------------------SEPARACION DE BASE DE DATOS NEGOFIN------------------------------------------------
Se crea un dump (backup) de la base de datos antes de empezar 
Contenedor del wildfly 1 esta corriendo en el puerto https 9101 y consola 9201
Se crea un segundo contenedor de wildfly que corre en el puerto https 9102 y consola 9202 con nombre digito-rse-emp2
Se crea un tercer contenedor de wildfly que corre en el puerto https 9103 y consola 9103 con nombre digito-rse-emp3

Se despliega el dump del backup en las otras dos bases de datos que llevan los nombres "negofin_cobranzas" y "nfd_SA"


Se identifica los idempresa que existen y en base a eso se realiza la separación de la base de datos

################################################################EMPRESA 1 ---- NEGOFIN SAECA----- INFO##################################################################################

corre en el enlace https://10.1.253.90:9101/payroll/ con la BASE DE DATOS LLAMADA digito_rse, dicha bd se encuentra limpia de las demas empresas, solamente se encuentran los datos de la empresa NEGOFIN SAECA

      idempres 1	= NEGOFIN S.A.E.C.A --> idliquidacion in(27,22,42,34,32,38,45,35,41);


##############################################################EMPRESA 2 ----- NEGOFIN COBRRANZAS S.A ----- INFO############################################################

idempresa 40	= NEGOFIN COBRANZAS S.A. --> idliquidacion in(36,46,43,31,24,39) ;; idusuario in(1737,

select * from base.empleado e  where idempleado in(1737,


ERRORES: LOS IDUSUARIOS --> 1,1494,1672,1321,1500 pertenecen a la empresa 1 y no estan pudiendo ser eliminados de la empresa 2 ya que en la empresa 2 hay comprobantes en donde se hace referencia a estos usuarios.
OBS: LOS DATOS DEL IDEMPRESA 41 fueron eliminados exitosamente

firmantes --> 1494, 1500
Importantes:   1499,1672, 1321, 1603, 1494, 1500, 1500, 1362
idusuario in(1499,1672, 1321, 1603, 1494, 1500, 1500, 1362)
                      
        
########################################################################EMPRESA 3 -----N.F.D S.A ------- INFO###############################################################################


idempresa 41	= N.F.D. S.A. --> idliquidacion in (30,


select * from base.usuario where idusuario in(1731,

idempleado in (1731,




-------------------------------------SCRIPTS UTILIZADOS------------------------------------------
select * from public.comprobante c  where idliquidacion in (30,


select * from public.liquidacionestado l  where idliquidacion in (30,


select * from public.lote l where idlote in(30,


select * from base.usuario where idusuario in(1731,
1735,

select * from base.usuariorol u  where idusuario in(1731,
1735,
##################################################################################################################################################################################################
#################################################################3SCRIPT PARA SOLUCIONAR EL PROBLEMA DE CARGA CON EL PASAPORTE EXTRANJERO###################################################################
-- DROP FUNCTION sifen.fn_trg_sifen_valid_generaldereceptor();

CREATE OR REPLACE FUNCTION sifen.fn_trg_sifen_valid_generaldereceptor()
RETURNS trigger
LANGUAGE plpgsql
AS $function$
DECLARE
vCodSifenTipoNatu VARCHAR;
vCodSifenTipoOpe VARCHAR;

BEGIN

IF TG_OP = 'UPDATE' THEN
IF EXISTS(SELECT *
FROM sifen.generaldereceptor gre
INNER JOIN sifen.documentoelectronicofueradefirma deff ON gre.idempresa = deff.idempresa
AND gre.idde = deff.idde
WHERE gre.idempresa = NEW.idempresa
AND gre.idde = NEW.idde
AND gre.idtiponaturalezareceptor <> OLD.idtiponaturalezareceptor
AND deff.caracterqr IS NOT NULL) THEN
SELECT base.fn_errorsifen_launcher('SGE08');
END IF;
END IF;

/* Naturaleza Receptor
* 1 - Contribuyente
* 2 - No Contribuyente
*/
SELECT TRIM(tnr.codigosifen)
INTO vCodSifenTipoNatu
FROM sifen.tiponaturalezareceptor tnr
WHERE tnr.idempresa = NEW.idempresa
AND tnr.idtiponaturalezareceptor = NEW.idtiponaturalezareceptor;

SELECT TRIM(tope.codigosifen)
INTO vCodSifenTipoOpe
FROM sifen.tipooperacion tope
WHERE tope.idempresa = NEW.idempresa
AND tope.idtipooperacion = NEW.idtipooperacion;

/*
Obligatorio si D201 = 1 No informar si D201 = 2
1= Persona Física
2= Persona Jurídica
*/
IF vCodSifenTipoNatu <> '1' AND NEW.idtipocontribuyente IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD204');
END IF;

IF vCodSifenTipoNatu = '1' AND NEW.idtipocontribuyente IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD205');
END IF;

IF vCodSifenTipoNatu = '1' AND (NEW.rucreceptor IS NULL OR NOT(LENGTH(TRIM(NEW.rucreceptor)) BETWEEN 3 AND 8)) THEN
SELECT base.fn_errorsifen_launcher('SD206');
END IF;

IF vCodSifenTipoNatu = '1' AND NEW.dvrucreceptor IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD207');
END IF;

-- Es "No Contribuyente" y se está enviando el ruc o el dv.
IF vCodSifenTipoNatu = '2' AND (NEW.rucreceptor IS NOT NULL OR NEW.dvrucreceptor IS NOT NULL) THEN
SELECT base.fn_errorsifen_launcher('SD277');
END IF;

/*IF vCodSifenTipoNatu = '2' AND vCodSifenTipoOpe <> '4' AND NEW.idtipodocumentoidentidad IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD208');
END IF;*/

IF vCodSifenTipoNatu = '2' AND NEW.idtipodocumentoidentidad IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD208');
END IF;

/*
* Obligatorio si D201 = 2 y D202 ≠ 4.
* No informar si D201 = 1
*/
/*IF (vCodSifenTipoNatu = '1' OR vCodSifenTipoOpe = '4') AND NEW.idtipodocumentoidentidad IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD213');
END IF;*/

/*IF vCodSifenTipoNatu = '2' AND vCodSifenTipoOpe <> '4' AND (NEW.nrodocumentoidentidad IS NULL OR TRIM(NEW.nrodocumentoidentidad) = '') THEN
SELECT base.fn_errorsifen_launcher('SD210');
END IF;*/

IF vCodSifenTipoNatu = '2' AND (NEW.nrodocumentoidentidad IS NULL OR TRIM(NEW.nrodocumentoidentidad) = '') THEN
SELECT base.fn_errorsifen_launcher('SD210');
END IF;

/*IF (vCodSifenTipoNatu = '1' OR vCodSifenTipoOpe = '4') AND NEW.nrodocumentoidentidad IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD215');
END IF;*/

IF EXISTS(SELECT *
FROM sifen.tipodocumentoidentidad tdi
WHERE tdi.idempresa = NEW.idempresa
AND tdi.idtipodocumentoidentidad = NEW.idtipodocumentoidentidad
-- 5 = Innominado
AND tdi.codigosifen = '5') AND
(NEW.nrodocumentoidentidad IS NULL OR TRIM(NEW.nrodocumentoidentidad) <> '0') THEN
SELECT base.fn_errorsifen_launcher('SD211');
END IF;

IF EXISTS(SELECT *
FROM sifen.tipodocumentoidentidad tdi
WHERE tdi.idempresa = NEW.idempresa
AND tdi.idtipodocumentoidentidad = NEW.idtipodocumentoidentidad
-- 5 = Innominado
AND tdi.codigosifen = '5') AND
(NEW.razonsocialreceptor IS NULL OR UPPER(TRIM(NEW.razonsocialreceptor)) <> 'SIN NOMBRE') THEN
SELECT base.fn_errorsifen_launcher('SD212');
END IF;

/* IF EXISTS(SELECT *
FROM sifen.tipodocumentoidentidad tdi
WHERE tdi.idempresa = NEW.idempresa
AND tdi.idtipodocumentoidentidad = NEW.idtipodocumentoidentidad
-- 7 = Otros tipo de documento de identidad.
AND tdi.codigosifen = '9')
AND (NEW.desctipodocumento IS NULL OR TRIM(NEW.desctipodocumento) = '') THEN
SELECT base.fn_errorsifen_launcher('SD214');
END IF;*/

IF EXISTS (
SELECT *
FROM sifen.tipodocumentoidentidad tdi
WHERE tdi.idempresa = NEW.idempresa
AND tdi.idtipodocumentoidentidad = NEW.idtipodocumentoidentidad
AND tdi.codigosifen = '9')
AND (NEW.desctipodocumento IS NULL OR TRIM(NEW.desctipodocumento) = '') THEN
SELECT base.fn_errorsifen_launcher('SD214');
END IF;

IF EXISTS (
SELECT *
FROM sifen.tipodocumentoidentidad tdi
WHERE tdi.idempresa = NEW.idempresa
AND tdi.idtipodocumentoidentidad = NEW.idtipodocumentoidentidad
AND tdi.codigosifen != '9')
AND (NEW.desctipodocumento IS NOT NULL OR TRIM(NEW.desctipodocumento) != '') THEN
SELECT base.fn_errorsifen_launcher('SD230');
END IF;

IF (EXISTS(SELECT *
FROM sifen.generaldereceptor grec
INNER JOIN sifen.timbrado ti ON grec.idempresa = ti.idempresa
AND grec.idde = ti.idde
INNER JOIN sifen.tipodocumentoelectronico tde ON ti.idempresa = tde.idempresa
AND ti.idtipodocumentoelectronico = tde.idtipodocumentoelectronico
WHERE grec.idempresa = NEW.idempresa
AND grec.idde = NEW.idde

-- 7 = Nota de Remisión Electrónica
AND tde.codigosifen = '7') OR vCodSifenTipoOpe = '4') AND
(NEW.direccionreceptor IS NULL OR TRIM(NEW.direccionreceptor) = '') THEN
SELECT base.fn_errorsifen_launcher('SD216');
END IF;

IF NOT (LENGTH(TRIM(NEW.razonsocialreceptor)) BETWEEN 4 AND 255) THEN
SELECT base.fn_errorsifen_launcher('SD217');
END IF;

IF NOT (LENGTH(TRIM(NEW.nombrefantasia)) BETWEEN 4 AND 255) THEN
SELECT base.fn_errorsifen_launcher('SD218');
END IF;

IF NEW.direccionreceptor IS NOT NULL AND TRIM(NEW.direccionreceptor) <> '' AND
NEW.nrocasareceptor IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD219');
END IF;

IF NEW.direccionreceptor IS NOT NULL AND TRIM(NEW.direccionreceptor) <> '' AND
vCodSifenTipoOpe <> '4' AND NEW.iddepartamento IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD220');
END IF;

IF vCodSifenTipoOpe = '4' AND NEW.iddepartamento IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD221');
END IF;

IF NEW.direccionreceptor IS NOT NULL AND TRIM(NEW.direccionreceptor) <> '' AND
vCodSifenTipoOpe <> '4' AND NEW.iddistrito IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD222');
END IF;

IF vCodSifenTipoOpe = '4' AND NEW.iddistrito IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD223');
END IF;

IF NEW.direccionreceptor IS NOT NULL AND TRIM(NEW.direccionreceptor) <> '' AND
vCodSifenTipoOpe <> '4' AND NEW.idciudad IS NULL THEN
SELECT base.fn_errorsifen_launcher('SD224');
END IF;

IF vCodSifenTipoOpe = '4' AND NEW.idciudad IS NOT NULL THEN
SELECT base.fn_errorsifen_launcher('SD225');
END IF;

IF NOT (LENGTH(TRIM(NEW.nrotelreceptor)) BETWEEN 6 AND 15) THEN
SELECT base.fn_errorsifen_launcher('SD226');
END IF;

IF NOT (LENGTH(TRIM(NEW.nrocelreceptor)) BETWEEN 10 AND 20) THEN
SELECT base.fn_errorsifen_launcher('SD227');
END IF;

/* IF NOT (LENGTH(TRIM(NEW.correoreceptor)) BETWEEN 3 AND 80) THEN
SELECT base.fn_errorsifen_launcher('SD228');
END IF;*/

IF NOT (LENGTH(TRIM(NEW.codigocliente)) BETWEEN 3 AND 31) THEN
SELECT base.fn_errorsifen_launcher('SD229');
END IF;

RETURN NULL;
END;
$function$
;

-- Permissions

ALTER FUNCTION sifen.fn_trg_sifen_valid_generaldereceptor() OWNER TO postgres;
GRANT ALL ON FUNCTION sifen.fn_trg_sifen_valid_generaldereceptor() TO public;
GRANT ALL ON FUNCTION sifen.fn_trg_sifen_valid_generaldereceptor() TO postgres;



reiniciar el servicio para que tome los cambios


##################################################################################################################################################################################################################################################
####################################################################################################################################
CAMBIAR EL ESTADO DE UN DE EN LA BASE DE DATOS CUANDO ESTA APROBADO EN LA SIFEN Y NO ACTUALIZA EN EL SISTEMA
Si el CDC del DE se encuentra en la sifen y aparece como APROBADO, se realizan los siguientes pasos.
select * from sifen.lotedetalleevento l where idde = 282927; se mira el ultimo estado que tiene el DE
select * from sifen.documentoelectronico d where idde = 282927; se cambia el estado a idestadoultimo = 1 para que este "APROBADO POR SIFEN"
#########################################################################################################################################################
CASO DE QUE UN DOCUMENTO SE GENERO EN LA INTERFAZ PERO NO CREO EL KUDE NI EL XML NI FIRMO, NORMALMENTE SE DEBE A QUE EL CAMPO "documentoAsociadoList" no se completo, se quedo vacio
En ese caso la solucion es eliminar esa nota de credito para volver a generar una con el mismo nro de documento. Aqui el script


delete from sifen.complementocomercial where idde = 297651;
DELETE FROM sifen.itemoperaciondescuento WHERE idde = 297651;
DELETE FROM sifen.itemoperacionprecio WHERE idde = 297651;
DELETE FROM sifen.itemoperacioniva WHERE idde = 297651;
DELETE FROM sifen.itemoperacion WHERE idde = 297651;
DELETE FROM sifen.notacredebelectronica WHERE idde = 297651;
delete from sifen.condicionoperacionpagocontado where idde = 297651;
delete from sifen.condicionoperacionpagocredito where idde = 297651;
delete from sifen.condicionoperacion where idde = 297651;
delete from sifen.especificodecampo where idde = 297651;
DELETE FROM sifen.especificode WHERE idde = 297651;
DELETE FROM sifen.generaldeemisor WHERE idde = 297651;
DELETE FROM sifen.generaldereceptor WHERE idde = 297651;
DELETE FROM sifen.operacioncomercial WHERE idde = 297651;
DELETE FROM sifen.generalde WHERE idde = 297651;
DELETE FROM sifen.operacionde WHERE idde = 297651;
DELETE FROM sifen.timbrado WHERE idde = 297651;

este script es de un caso especial ya que el script es solo cuando no existe documentos asociados en la nota de credito, se remplaza el idde del documento que queremos eliminar y se realiza
#######################3#####################################################################################################################################################################################################################
#######################3########################################################################SISTEMA POLIZAS##############################################################################################################################
SCRIPT PARA VISUALIZAR LAS ACCIONES DE CADA PLAN
select p.idplan , pl.codigo , t.descripcion , p.orden from plantipoaccion p
join plan pl on pl.idplan = p.idplan
join tipoaccion t on t.idtipoaccion = p.idtipoaccion
where p.idplan not in (35,
28,
26)
order by p.idplan, orden
#############No utilizar estos planes de poliza ya que estan apuntando a la producción##############
PDNA5
PDNA6
PLPO6
#######################3####################################################################################################################################################################################################################
PETICION HTTP
En este apartado del standalone.xml se define el maximo de envio de datos por https/https con max-post-size

<server>
<http-listener name="default" read-timeout="20000" socket-binding="http" max-post-size="2500000" redirect-socket="https" enable-http2="true"/>
<https-listener name="https" read-timeout="20000" socket-binding="https" max-post-size="2500000" security-realm="SalarioDigitalRealm" enable-http2="true"/>
######################FORMATO DE FECHA CONVERTIDO#########################
ES FORMATO EPOCH cuando se convierte una fecha normal a un formato de numeros seguidos
##########################COmando para configurar un certificado SSL en un contenedor de docker####################################3
/opt/java/bin/keytool -import -trustcacerts -alias digito_com_py_cert -file /opt/java/digito-com-py.pem -keystore /opt/java/lib/security/cacerts
#################################################
PARA INSTALAR POR SERVICIO, WILDFLY EN WINDOWS
en la carpeta docs/contrib/scripts/service se encuentra el .bat "service.bat"
Se copia el service.bat en la carpeta bin del wildfly y se abre el cmd dentro de la carpeta bin
se ejecuta el siguiente comando: "service.bat install"
########################################################
Puedes migrar un contenedor Docker de un servidor a otro sin alterar la imagen ni tener que volver a montarla utilizando Docker CLI y algunas herramientas integradas de Docker. Aquí te dejo un proceso paso a paso:

    Detener el contenedor: Primero, detén el contenedor que deseas migrar en el servidor de origen utilizando el siguiente comando:

    arduino

docker stop <nombre_del_contenedor>

Exportar el contenedor a un archivo tar: Utiliza el comando docker export para exportar el contenedor a un archivo tar. Esto creará un archivo tar que contiene el sistema de archivos del contenedor.

arduino

docker export <nombre_del_contenedor> > contenedor.tar

Transferir el archivo tar al servidor de destino: Utiliza herramientas de transferencia de archivos como SCP o rsync para transferir el archivo tar generado al servidor de destino.

ruby

scp contenedor.tar usuario@servidor_destino:/ruta/destino

Importar el contenedor en el servidor de destino: Una vez que el archivo tar esté en el servidor de destino, utiliza el comando docker import para importar el archivo tar como una nueva imagen Docker.

arduino

docker import contenedor.tar <nombre_de_la_nueva_imagen>

Crear y ejecutar un nuevo contenedor a partir de la nueva imagen: Ahora que tienes la nueva imagen en el servidor de destino, puedes crear y ejecutar un nuevo contenedor utilizando esta imagen.

php

    docker run --name <nombre_del_nuevo_contenedor> -d <nombre_de_la_nueva_imagen>

##########################################################################################################################################
que configurar en una implementacion DFE INTERFAZ 
Tablas relacionadas a la empresa con el idempresa = 2
Se configura el timbrado y todo lo referente a este en las tablas relacionadas a "timbrado"



####################################################SERVIDOR DE CORREOS OAUTH 2.0###################################################################
Para obtener el token de microsoft se envia una peticion al siguiente enlace: https://login.microsoftonline.com/{{tenant}}/oauth2/v2.0/token


con los siguientes parametros:

client_secret=

scope=

client_id=

grant_type=
ss
username=

password=


Y la respuesta deberia ser 200 OK con la siguiente estructura:
{
    "token_type": "Bearer",
    "scope": "https://outlook.office.com/SMTP.Send https://outlook.office.com/User.Read",
    "expires_in": 4738,
    "ext_expires_in": 4738,
    "access_token": "eyJ0eXAiOiJKV1QiLCJub25jZSI6IktCd0NNa1ZUSnBmeDZTS3RVMDA4VDRLQmJ4WVFsaVVNQ1FVbWNOaFJkTEEiLCJhbGciOiJSUzI1NiIsIng1dCI6IkwxS2ZLRklfam5YYndXYzIyeFp4dzFzVUhIMCIsImtpZCI6IkwxS2ZLRklfam5YYndXYzIyeFp4dzFzVUhIMCJ9.eyJhdWQiOiJodHRwczovL291dGxvb2sub2ZmaWNlLmNvbSIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzY2N2I0N2U5LTkzNmUtNGYxYy1hNjQ4LTRjYjUxZDY2NmE1Ny8iLCJpYXQiOjE3MTY4Mjk0ODcsIm5iZiI6MTcxNjgyOTQ4NywiZXhwIjoxNzE2ODM0NTI2LCJhY2N0IjowLCJhY3IiOiIxIiwiYWlvIjoiQVRRQXkvOFdBQUFBNkxIai9WTENzY3E0STZvZWhMSzM5OUdlR2dNZkxVbXprVWJXNFplY3VyNFNHVXI0TWpWSUkyZllGK05TbGZqbCIsImFtciI6WyJwd2QiXSwiYXBwX2Rpc3BsYXluYW1lIjoiU2FsYXJpb3NfQVBQIiwiYXBwaWQiOiJlNDliMzRjMC01NGE2LTQ2NjQtOWVkMi03YmQ5MGIzMWQxZTgiLCJhcHBpZGFjciI6IjEiLCJlbmZwb2xpZHMiOltdLCJpcGFkZHIiOiIxOTAuMTI4LjEzNC4xMDIiLCJsb2dpbl9oaW50IjoiTy5DaVE0TVRaa1lURXhNUzB3TkRNeExUUmtOekl0T0dFek1TMHdOamMwT1RrNFpUUXpNMk1TSkRZMk4ySTBOMlU1TFRrek5tVXROR1l4WXkxaE5qUTRMVFJqWWpVeFpEWTJObUUxTnhva1ptRmpkSFZ5WVdOcGIyNWxiR1ZqZEhKdmJtbGpZVUIwWVhCcGRHa3VZMjl0TG5CNUlBdz0iLCJuYW1lIjoiRkFDVFVSQUNJw5NOIEVMRUNUUsOTTklDQSIsIm9pZCI6IjgxNmRhMTExLTA0MzEtNGQ3Mi04YTMxLTA2NzQ5OThlNDMzYyIsInB1aWQiOiIxMDAzMjAwMjZDOTBDMDUzIiwicmgiOiIwLkFWa0E2VWQ3Wm02VEhFLW1TRXkxSFdacVZ3SUFBQUFBQVBFUHpnQUFBQUFBQUFDZEFHMC4iLCJzY3AiOiJTTVRQLlNlbmQgVXNlci5SZWFkIiwic2lkIjoiNGU1Y2UzMGMtZTY0ZS00ZDQ5LWI2MTItN2JiNTMxNmMwNGVlIiwic3ViIjoiWW5pQ0lVSnJUT3lZd3FwOHJRV2xYNTdHTno1b0dDWnQ0YnBPUzNxdnVZdyIsInRpZCI6IjY2N2I0N2U5LTkzNmUtNGYxYy1hNjQ4LTRjYjUxZDY2NmE1NyIsInVuaXF1ZV9uYW1lIjoiZmFjdHVyYWNpb25lbGVjdHJvbmljYUB0YXBpdGkuY29tLnB5IiwidXBuIjoiZmFjdHVyYWNpb25lbGVjdHJvbmljYUB0YXBpdGkuY29tLnB5IiwidXRpIjoiREdESWp0M0ZsVWlQZTZDY0hRd25BUSIsInZlciI6IjEuMCIsIndpZHMiOlsiYjc5ZmJmNGQtM2VmOS00Njg5LTgxNDMtNzZiMTk0ZTg1NTA5Il19.Mac4tMAKEzmVPqYRXygW3CuxjRqtPMEKUKWVZN2XIlLwRRLQpj_ZbLfqfeNpA79SIIlZ-BZ0EJyms0-ZVYalUU6tRCLPyeMtN081_4LaVSDpgz_-Ets2yaHy7qTc1OZsyRkekFIijQ1ESUPdxgHVi8vb4-GO0bRFTF-tRMRWpg3fIYLEv7N6R7Yss2Q1WTDeAwtWsjhrn7uvi6OSIZxsJJhVHRvvEyKHePVIjX_eNa9etqheRU0X3CLj3tdlvJgouGW7rcx8l2v4BqJNT9LX2vRcqdTSsK0da8WVOqayQ3k4jZxGKXYyeKjHRO7tpDoxPUuxYranL9Io3z1RuNORmA"
}

La respuesta incorrecta en caso de que las credenciales sean invalidas: 
{
    "error": "invalid_grant",
    "error_description": "AADSTS50126: Error validating credentials due to invalid username or password. Trace ID: c7084916-f593-43b3-845f-d54d4d550a01 Correlation ID: 2c291593-012f-4295-9a66-6d93938e8a62 Timestamp: 2024-05-27 19:12:31Z",
    "error_codes": [
        50126
    ],
    "timestamp": "2024-05-27 19:12:31Z",
    "trace_id": "c7084916-f593-43b3-845f-d54d4d550a01",
    "correlation_id": "2c291593-012f-4295-9a66-6d93938e8a62",
    "error_uri": "https://login.microsoftonline.com/error?code=50126"
}

#################################Coomando de nohup para levantar el wildfly en caso de que no funcione por servicio#####
nohup ./standalone.sh -Djboss.server.base.dir=/opt/demos/sirius/wildfly-17.0.1.Final/standalone &


#####################OAUTH DFE####################################
Pedir datos al cliente sobre el tenant, los cuales son:

ID_Tenant:
Client_secret: (tambien suelen pasar este con el nombre "valor")
Id_client: (suele estar con el nombre "id_dispositivo")
username:
Contraseña:

-el ID tenant se configura en sirius-config-propierties 
-dirigirse en el apartado "DATOS AUTENTICACION OAUTH" y cargar el ID_Tenant en "mail.tanant.id"
-en mail.endpoint.oauth se cargaria asi "https://login.microsoftonline.com/(mail.tenant.id)/oauth2/v2.0/token"
-mail.smtp.oauth.enable = yes

El resto seria en oauth-config-propierties
cargar en este archivo:
-client_secret
-client_id
-username
-password

(para realizar pruebas, utilizar la biblioteca de postman)

##################################################Eliminar todos los comprobantes de liquidaciones RSE#################################################
delete from public.comprobantetotal;
delete from public.comprobanteinformacionadicional;
delete from public.comprobantefirma;
delete from public.comprobanteestado;
delete from public.comprobantedetalle;
delete from public.comprobante;
delete from public.liqprocesofirma;
delete from public.liquidacionestado;
delete from public.liquidacion;
delete from public.lote;

com.documenta.libkude.html2pdf.PrintFacturaKuDENegoServi

OBS: Esto eliminara TODOS los comprobantes, en caso de querer eliminar una sola liquidacion, hacerlo por idliquidacion y idlote

##########################################################Listar parametros de FE###############################
    select spv.idempresa, spv.idsisparam, sp.idsisparam, sp."key", spv.value
    from base.sis_param_value spv
    join base.sis_param sp
    on sp.idsisparam = spv.idsisparam
    where idempresa = 2 order by spv.idsisparam;

####################################################################################################################
delete from sifen.complementocomercial where idde = 297651;
DELETE FROM sifen.itemoperaciondescuento WHERE idde = 297651;
DELETE FROM sifen.itemoperacionprecio WHERE idde = 297651;
DELETE FROM sifen.itemoperacioniva WHERE idde = 297651;
DELETE FROM sifen.itemoperacion WHERE idde = 297651;
DELETE FROM sifen.notacredebelectronica WHERE idde = 297651;
delete from sifen.condicionoperacionpagocreditocuota where idde = 297651;
delete from sifen.condicionoperacionpagocredito where idde = 297651;
delete from sifen.condicionoperacion where idde = 297651;
delete from sifen.especificodecampo where idde = 297651;
DELETE FROM sifen.especificode WHERE idde = 297651;
DELETE FROM sifen.generaldeemisor WHERE idde = 297651;
DELETE FROM sifen.generaldereceptor WHERE idde = 297651;
DELETE FROM sifen.operacioncomercial WHERE idde = 297651;
DELETE FROM sifen.generalde WHERE idde = 297651;
DELETE FROM sifen.operacionde WHERE idde = 297651;
DELETE FROM sifen.timbrado WHERE idde = 297651;
DELETE FROM sifen.documentoelectronicototal WHERE idde = 297651;
DELETE FROM sifen.documentoelectronicofueradefirma  WHERE idde = 297651;
delete from sifen.lotedetalleevento WHERE idde = 297651;
delete from sifen.documentoelectronicototal WHERE idde = 297651;
DELETE FROM sifen.documentoelectronico WHERE idde = 297651;

BORRAR FACTURA
#####################################################################################
select * from sifen.timbrado t where nrodeldocumento = 51 ; ---busqueda por nro de documento


################################################################################################
2024-07-03 09: 32: 48,
057 ERROR [com.documenta.sirius.rest.api.integration.InterfaceREST
] (default task-3) Error al intentar procesar el SDE recibido.: com.documenta.sirius.ejb.exception.SiriusEJBException: No se pudo obtener la lista de SDE por id.


Significa que algo se envio mal en el apartado "timbrado", ya sea la caja, la sucursal o el tipo de documento electronico 



##########################################################################################################3
Si queremos que una variable en el html desapareza cuando se le mande 0 en el CSV, el DIV de esa variable debe ser de tipo "INFO date", con esto va a desaparecer si se le manda 0



####################################################################################
Caused by: com.documenta.siriusjobs.ejb.exception.SiriusJobsEJBException: El archivo XML Firmado no fue creado para [idEmpresaSirius: 2, IdDeSirius: 283165, codEmpresa: null, versionXML: null]
	at com.documenta.siriusjobs.ejb.service.KuDEService.getXMLFile(KuDEService.java:219)
	... 130 more

Este error se suele dar cuando el XML no se crea, y por lo tanto las notificaciones del documento no se realizan correctamente, para solucionar esto, se debe descargar el XML desde la interfaz para que se almacene en la carpeta, y ahi volvera a enviar las notificaciones


############################################Hacerle mantenimiento a un servidor para liberar espacio innecesario########################################
Ver la cantidad de uso de los contenedores:    docker system df 


luego con el comando du -hs /* | sort -hr busco que directorio ocupa mayor espacio
en este caso era el directorio /var/ dentor de var empece a ustilizar du -hs * | sort -nr para ver que subdirectorio pesaba mas
hasta llegar al directorio /var/lib/docker/containers



para no borrar y evitar problemas lo que hice fue un truncate -s 0 6501db72ddef9c4ae76866a5b49f4f23c529a5cd09e12f0b28c0322728b153cf-json.log


#############################################Borrar cache en el SO########################################################################################

sudo sh -c "sync; echo 3 > /proc/sys/vm/drop_caches"

##############################################



####################################################CONFIGURACIONES PARA FIRMAS DESATENDIDAS#############################################

SERVIDOR DE CORREOS DE DOCUMENTA ---> TABLA base.mailproperties

idproperty	        property.key	                    descripción	                                            value
1	                mail.debug	                        Modo debug	                                            true
2	                mail.smtp.host	                    Host para correo smtp	                                mail.documenta.com.py
3	                mail.smtp.port	                    Puerto para correo smtp	                                587
4	                mail.smtp.timeout	                Tiempo máximo de espera para operación para correo	    10000
5	                mail.smtp.connectiontimeout	        Tiempo de espera en la conexión	                        10000
6	                mail.smtp.user	                    Usuario para conexión smtp	                            usuario2@documenta.com.py
7	                mail.smtp.password	                Contraseña para conexión smtp	                        Enero24#
8	                mail.smtp.starttls.enable	        Protocolo TLS	                                        true
9	                mail.smtp.ssl.trust	                Confianza en certificado SSL	                        mail.documenta.com.py
10	                mail.smtp.socketFactory.port	    Puerto socket Factory	                                [NULL]
11	                mail.smtp.socketFactory.class	    Clase de socket factory	                                [NULL]
12	                mail.smtp.socketFactory.fallback	Fallback ssl enabled	                                false
13	                mail.oauth.tanaid	                Tanant id para autenticación oauth	                    306eb5c4-5697-40b3-ae04-65c9d7ac95f5
14	                mail.oauth.properties	            Propiedades para autenticación oauth en imap	        [NULL]
15	                mail.read.limit.time	            Tiempo límite de espera para la lectura de OTP	        120000
16	                mail.store.protocol	                Protocolo para lectura de correos	                    imap
17	                mail.imap.host	                    Host para correo de lectura	                            mail.documenta.com.py
18	                mail.imap.port	                    Puerto para correo de lectura	                        993
19	                mail.imap.ssl.enable	            Protocolo ssl habilitado	                            true
20	                mail.imap.auth	                    Requiere autenticación	                                true
21	                mail.imap.auth.mechanisms	        Método de autenticación imap	                        [NULL]
22	                mail.smtp.auth	                    Requiere autenticación smtp	                            [NULL]
23	                mail.smtp.auth.mechanisms	        Método de autenticación smtp	                        XOAUTH2
24	                mail.oauth.properties	            Propiedades para autenticación oauth en smtp	        client_secret=q6u8Q~Tmws820gEqbIY7f8miGxQDr

################################################SIGNBOX##########################################################################
Para la version del firmador de la 96 y 135 debe de revisarse la carpeta /home/dir_payroll dentro de contenedor y borrar los archivos de dias anteriores porque se llena, ya que muchas veces signbox no responde en los 15 segundos que aguardamos su respuesta
En la nueva vesion ya hay un timer que verifica esa carpeta y elimina los archivos almancenados por mas de 12 horas
Algunas veces signbox retorna el archivo firmado pero luego de los 15 segundos, seria para estos casos. Si responde dentro de esos 15 segundos, luego de aplicar la firma ya se elimina el archivo firmado

###############################################Levantar dos ambientes de wildfly en el mismo servidor windows######################
Servidor principal (PROD) --> se va a levantar por servicio como siempre
Servidor secundario (Test) --> se va a levantar por .bat


Para el segundo se realiza la copia de la carpeta standalone, sirius y se le concatena "test" en caso de que sea test

Luego, en la carpeta bin se duplica el standalone, y se le cambia el nombre a "_test", y en el script en el apartado de restart se agrega lo siguiente ""-Djboss.server.base.dir=C:\opt\wildfly-17.0.1.Final\standalone_test" ^"

De la siguiente manera:

:RESTART
  "%JAVA%" %JAVA_OPTS% ^
   "-Dorg.jboss.boot.log.file=%JBOSS_LOG_DIR%\server.log" ^
   "-Dlogging.configuration=file:%JBOSS_CONFIG_DIR%/logging.properties" ^
      -jar "%JBOSS_HOME%\jboss-modules.jar" ^
      %MODULE_OPTS% ^
      -mp "%JBOSS_MODULEPATH%" ^
      org.jboss.as.standalone ^
      "-Djboss.home.dir=%JBOSS_HOME%" ^
	  "-Djboss.server.base.dir=C:\opt\wildfly-17.0.1.Final\standalone_test" ^
      %SERVER_OPTS%

if %errorlevel% equ 10 (
	goto RESTART
)

:END
if "x%NOPAUSE%" == "x" pause

:END_NO_PAUSE

Esto para que pueda tomar la variable y apunte a otro dominio que no sea el standalone normal



#####################################################################################################################
Luego de actualizar a cada cliente a la ultima versión se debe realizar lo siguiente:

Crear una cuenta de firmador web para cada cliente que tenga la versión del firmador web (30.135 y 30.92)

entrar en la 30.135 o 30.92
agregar una "empresa" con el nombre del cliente
crear un usuario con el formato nombrecliente
Usuario Normal
Usuario firmador -- > rol

"nombrecliente@correo.com"

para la version pettengill se debe configurar el parametro 59 "dfw.api.password" desde la interfaz para que pueda encriptarse la contraseña
se debe configurar el parametro 62 dfw.api.user con el usuario creado anteriormente y el password en el parametro 59

####################################################################################################################################################33
1- Agregar el archivo .p12 o pfx en la carpeta configuration del standalone

2- en el estandalone.xml editar lo siguiente:

Editar esto:
<server name="default-server">
<http-listener name="default" socket-binding="http" max-post-size="52428800" redirect-socket="https" enable-http2="true"/>
<https-listener name="https" socket-binding="https" max-post-size="52428800" security-realm="SalarioDigitalRealm" enable-http2="true"/>
<host name="default-host" alias="localhost">
<location name="/" handler="welcome-content"/>
<location name="/payroll" handler="payroll-content"/>
<http-invoker security-realm="SalarioDigitalRealm"/>
</host>
</server>

Agregar esto:
<security-realm name="SalarioDigitalRealm">
<server-identities>
<ssl>
<keystore path="wildcard_fapasa_com_py.pfx" relative-to="jboss.server.config.dir" keystore-password="1qazxsw2"/>
</ssl>
</server-identities>
</security-realm>
</security-realms>

###################################ELIMINAR EL DOMINIO DEL USUARIO PAYROLL##############33
update base.usuario set username = substring(username, 1, position('@' in username) - 1);


###########################################Redireccionar siempre el enlace a /payroll######################################
Para que se pueda ingresar a la aplicacion sin colocar necesariamente "/payroll" se realiza la siguiente configuracion:

En /opt/wildfly.x.x.x/welcome-content modificar el archivo index.html agregar

<meta http-equiv="Refresh" content="0; url='./payroll'" />

y hace la redireccion